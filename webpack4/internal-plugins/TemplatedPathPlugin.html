<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>TemplatedPathPlugin | 卑鄙智</title><meta name="description" content=""><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/blog-site/assets/js/runtime~app.b8391e89.js" as="script"><link rel="preload" href="/blog-site/assets/css/styles.ec008df3.css" as="style"><link rel="preload" href="/blog-site/assets/js/4640.d13a5239.js" as="script"><link rel="preload" href="/blog-site/assets/js/app.20f347e0.js" as="script">
    <link rel="stylesheet" href="/blog-site/assets/css/styles.ec008df3.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/blog-site/" class=""><img class="logo" src="/blog-site/assets/logo.jpeg" alt="卑鄙智"><span class="site-name can-hide">卑鄙智</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Vue 源码合集"><span class="title">Vue 源码合集</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Vue 源码合集"><span class="title">Vue 源码合集</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blog-site/vue2/README.md" class="nav-link" aria-label="v2"><!--[--><!--]--> v2 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/blog-site/vue3/README.md" class="nav-link" aria-label="v3"><!--[--><!--]--> v3 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="webpack 源码合集"><span class="title">webpack 源码合集</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="webpack 源码合集"><span class="title">webpack 源码合集</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blog-site/webpack4/README.md" class="nav-link" aria-label="v4.46.0"><!--[--><!--]--> v4.46.0 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/blog-site/webpack5/README.md" class="nav-link" aria-label="v5"><!--[--><!--]--> v5 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="计算机基础知识"><span class="title">计算机基础知识</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="计算机基础知识"><span class="title">计算机基础知识</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blog-site/networks/README.md" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/blog-site/nginx/README.md" class="nav-link" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/theniceangel" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Vue 源码合集"><span class="title">Vue 源码合集</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Vue 源码合集"><span class="title">Vue 源码合集</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blog-site/vue2/README.md" class="nav-link" aria-label="v2"><!--[--><!--]--> v2 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/blog-site/vue3/README.md" class="nav-link" aria-label="v3"><!--[--><!--]--> v3 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="webpack 源码合集"><span class="title">webpack 源码合集</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="webpack 源码合集"><span class="title">webpack 源码合集</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blog-site/webpack4/README.md" class="nav-link" aria-label="v4.46.0"><!--[--><!--]--> v4.46.0 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/blog-site/webpack5/README.md" class="nav-link" aria-label="v5"><!--[--><!--]--> v5 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="计算机基础知识"><span class="title">计算机基础知识</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="计算机基础知识"><span class="title">计算机基础知识</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/blog-site/networks/README.md" class="nav-link" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/blog-site/nginx/README.md" class="nav-link" aria-label="nginx"><!--[--><!--]--> nginx <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/theniceangel" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">术语</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/term/module.html" class="nav-link sidebar-item" aria-label="module"><!--[--><!--]--> module <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/term/chunk.html" class="nav-link sidebar-item" aria-label="chunk"><!--[--><!--]--> chunk <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/term/entrypoint&amp;chunkGroup.html" class="nav-link sidebar-item" aria-label="chunkGroup、entrypoint"><!--[--><!--]--> chunkGroup、entrypoint <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/term/dependency&amp;moduleFactory.html" class="nav-link sidebar-item" aria-label="dependency、moduleFactory"><!--[--><!--]--> dependency、moduleFactory <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">tapable</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/tapable" class="nav-link sidebar-item" aria-label="Tapable"><!--[--><!--]--> Tapable <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">流程图</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/introduction/flow-diagram.html" class="nav-link sidebar-item" aria-label="webpack 流程图"><!--[--><!--]--> webpack 流程图 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">编译全流程</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/webpack-process/startup.html" class="nav-link sidebar-item" aria-label="准备工作"><!--[--><!--]--> 准备工作 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/webpack-process/handle-options.html" class="nav-link sidebar-item" aria-label="处理 options"><!--[--><!--]--> 处理 options <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/webpack-process/new-compiler.html" class="nav-link sidebar-item" aria-label="处理 compiler"><!--[--><!--]--> 处理 compiler <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/webpack-process/inner-plugins.html" class="nav-link sidebar-item" aria-label="处理 innerPlugins"><!--[--><!--]--> 处理 innerPlugins <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/webpack-process/run-compiler.html" class="nav-link sidebar-item" aria-label="运行 compiler"><!--[--><!--]--> 运行 compiler <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/webpack-process/before-compile.html" class="nav-link sidebar-item" aria-label="编译之前"><!--[--><!--]--> 编译之前 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/webpack-process/compiling.html" class="nav-link sidebar-item" aria-label="编译进行时"><!--[--><!--]--> 编译进行时 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/webpack-process/compiling-modules.html" class="nav-link sidebar-item" aria-label="模块解析"><!--[--><!--]--> 模块解析 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">路径解析</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/module-resolver/" class="nav-link sidebar-item" aria-label="引言"><!--[--><!--]--> 引言 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/module-resolver/Resolver.html" class="nav-link sidebar-item" aria-label="Resolver"><!--[--><!--]--> Resolver <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/module-resolver/ResolverFactory.html" class="nav-link sidebar-item" aria-label="ResolverFactory"><!--[--><!--]--> ResolverFactory <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Loader 原理</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/loaders/" class="nav-link sidebar-item" aria-label="Loaders"><!--[--><!--]--> Loaders <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog-site/webpack4/loaders/loader-runner.html" class="nav-link sidebar-item" aria-label="loader-runner"><!--[--><!--]--> loader-runner <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item active">webpack 内部插件合集</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/internal-plugins/entry/EntryOptionPlugin.html" class="nav-link sidebar-item" aria-label="EntryOptionPlugin"><!--[--><!--]--> EntryOptionPlugin <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog-site/webpack4/internal-plugins/TemplatedPathPlugin.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="TemplatedPathPlugin"><!--[--><!--]--> TemplatedPathPlugin <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blog-site/webpack4/internal-plugins/TemplatedPathPlugin.html#类声明" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="类声明"><!--[--><!--]--> 类声明 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog-site/webpack4/internal-plugins/TemplatedPathPlugin.html#assetpath" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="assetPath"><!--[--><!--]--> assetPath <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog-site/webpack4/internal-plugins/TemplatedPathPlugin.html#globalhash" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="globalHash"><!--[--><!--]--> globalHash <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog-site/webpack4/internal-plugins/TemplatedPathPlugin.html#hashforchunk" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="hashForChunk"><!--[--><!--]--> hashForChunk <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/blog-site/webpack4/internal-plugins/WarnCaseSensitiveModulesPlugin.html" class="nav-link sidebar-item" aria-label="WarnCaseSensitiveModulesPlugin"><!--[--><!--]--> WarnCaseSensitiveModulesPlugin <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">webpack 第三方库</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/third-dependencies/" class="nav-link sidebar-item" aria-label="总览"><!--[--><!--]--> 总览 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">webpack 配置项</p><ul class=""><li><!--[--><a href="/blog-site/webpack4/configuration/" class="nav-link sidebar-item" aria-label="Configuration"><!--[--><!--]--> Configuration <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="templatedpathplugin" tabindex="-1"><a class="header-anchor" href="#templatedpathplugin" aria-hidden="true">#</a> TemplatedPathPlugin</h1><p>webpack 使用一种 <code>&#39;substitutions&#39;</code> 的技术，支持 <code>output.filename</code>、<code>output.chunkFilename</code> 等配置，它可以使用如下的占位符来替换构建流程中对应的值。</p><table><thead><tr><th>template</th><th>作用</th></tr></thead><tbody><tr><td>[hash]</td><td>module id 的哈希值</td></tr><tr><td>[contenthash]</td><td>文件内容的哈希</td></tr><tr><td>[chunkhash]</td><td>chunk 内容的哈希值</td></tr><tr><td>[name]</td><td>模块名称</td></tr><tr><td>[id]</td><td>module id</td></tr><tr><td>[query]</td><td>module 的 query，<code>&#39;?&#39;</code> 之后的值</td></tr><tr><td>[function]</td><td>返回 filename 的函数</td></tr></tbody></table><h2 id="类声明" tabindex="-1"><a class="header-anchor" href="#类声明" aria-hidden="true">#</a> 类声明</h2><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#24292e;"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TemplatedPathPlugin</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">apply</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">compiler</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    compiler.hooks.compilation.</span><span style="color:#B392F0;">tap</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;TemplatedPathPlugin&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">compilation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">mainTemplate</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> compilation.mainTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      mainTemplate.hooks.assetPath.</span><span style="color:#B392F0;">tap</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;TemplatedPathPlugin&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        replacePathVariables</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      mainTemplate.hooks.globalHash.</span><span style="color:#B392F0;">tap</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;TemplatedPathPlugin&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#FFAB70;">chunk</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">paths</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      mainTemplate.hooks.hashForChunk.</span><span style="color:#B392F0;">tap</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;TemplatedPathPlugin&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#FFAB70;">hash</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">chunk</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">// ...</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span></code></pre></div><p>TemplatedPathPlugin 内部含有许多正则，都是为了匹配占位符变量。</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#24292e;"><code><span class="line"><span style="color:#6A737D;">// 全局匹配版本</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">REGEXP_HASH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">hash(?::(</span><span style="color:#79B8FF;">\d</span><span style="color:#F97583;">+</span><span style="color:#DBEDFF;">))</span><span style="color:#F97583;">?</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [hash] 或者 [hash:数字]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_CHUNKHASH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">chunkhash(?::(</span><span style="color:#79B8FF;">\d</span><span style="color:#F97583;">+</span><span style="color:#DBEDFF;">))</span><span style="color:#F97583;">?</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [chunkhash] 或者 [chunkhash:数字]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_MODULEHASH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">modulehash(?::(</span><span style="color:#79B8FF;">\d</span><span style="color:#F97583;">+</span><span style="color:#DBEDFF;">))</span><span style="color:#F97583;">?</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [modulehash] 或者 [modulehash:数字]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_CONTENTHASH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">contenthash(?::(</span><span style="color:#79B8FF;">\d</span><span style="color:#F97583;">+</span><span style="color:#DBEDFF;">))</span><span style="color:#F97583;">?</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [contenthash] 或者 [contenthash:数字]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#DBEDFF;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">name</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [name]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#DBEDFF;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">id</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [id]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_MODULEID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#DBEDFF;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">moduleid</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [moduleid]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_FILE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#DBEDFF;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">file</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [file]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_QUERY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#DBEDFF;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">query</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [query]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_FILEBASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#DBEDFF;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">filebase</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// 匹配 [filebase]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_URL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#DBEDFF;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">url</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// 匹配 [url]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 非全局匹配版本</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">REGEXP_HASH_FOR_TEST</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">RegExp</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_HASH</span><span style="color:#E1E4E8;">.source, </span><span style="color:#9ECBFF;">&quot;i&quot;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_CHUNKHASH_FOR_TEST</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">RegExp</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_CHUNKHASH</span><span style="color:#E1E4E8;">.source, </span><span style="color:#9ECBFF;">&quot;i&quot;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_CONTENTHASH_FOR_TEST</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">RegExp</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_CONTENTHASH</span><span style="color:#E1E4E8;">.source, </span><span style="color:#9ECBFF;">&quot;i&quot;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">REGEXP_NAME_FOR_TEST</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">RegExp</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_NAME</span><span style="color:#E1E4E8;">.source, </span><span style="color:#9ECBFF;">&quot;i&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span></code></pre></div><p>插件的主要逻辑分为 <code>assetPath</code>、<code>globalHash</code>、<code>hashForChunk</code> 三个 hooks，下面分别看看这三个 hooks 的作用。</p><h2 id="assetpath" tabindex="-1"><a class="header-anchor" href="#assetpath" aria-hidden="true">#</a> assetPath</h2><p>assetPath 是用了替换 <code>output.filename</code>、<code>output.path</code> 等配置内的占位符变量。它的调用路径如下：</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#24292e;"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Compilation</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">getPath</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">filename</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> {};</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 默认为 compilation.hash</span></span>
<span class="line"><span style="color:#E1E4E8;">    data.hash </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data.hash </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hash;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// filename：带有占位符的模版字符串</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainTemplate.</span><span style="color:#B392F0;">getAssetPath</span><span style="color:#E1E4E8;">(filename, data);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">getPathWithInfo</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">filename</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    data </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> {};</span></span>
<span class="line"><span style="color:#E1E4E8;">    data.hash </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data.hash </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hash;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.mainTemplate.</span><span style="color:#B392F0;">getAssetPathWithInfo</span><span style="color:#E1E4E8;">(filename, data);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MainTemplate</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">getPublicPath</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">options</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hooks.assetPath.</span><span style="color:#B392F0;">call</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.outputOptions.publicPath </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      options</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">getAssetPath</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">path</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">options</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hooks.assetPath.</span><span style="color:#B392F0;">call</span><span style="color:#E1E4E8;">(path, options);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">getAssetPathWithInfo</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">path</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">options</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">assetInfo</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {};</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">newPath</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hooks.assetPath.</span><span style="color:#B392F0;">call</span><span style="color:#E1E4E8;">(path, options, assetInfo);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> { path: newPath, info: assetInfo };</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span></code></pre></div><p>先来看下 <code>replacePathVariables</code> 函数的逻辑。</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#24292e;"><code><span class="line"><span style="color:#6A737D;">// 返回一个 replacer 函数</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">value</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">allowEmpty</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// replacer 函数会将 value 替换成对应的字符串模版，比如 value 为 &#39;index&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 比如 &#39;[name].js&#39; 替换成  &#39;index.js&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">match</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">...</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">input</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> args[args.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (value </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> value </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">undefined</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">allowEmpty) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">`Path variable ${</span><span style="color:#E1E4E8;">match</span><span style="color:#9ECBFF;">} not implemented in this context: ${</span><span style="color:#E1E4E8;">input</span><span style="color:#9ECBFF;">}`</span></span>
<span class="line"><span style="color:#E1E4E8;">        );</span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`${</span><span style="color:#B392F0;">escapePathVariables</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">value</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">}`</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  };</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> fn;</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">escapePathVariables</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> value </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;string&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> value.</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[</span><span style="color:#DBEDFF;">(</span><span style="color:#85E89D;font-weight:bold;">\\</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">[\w:]</span><span style="color:#F97583;">+</span><span style="color:#85E89D;font-weight:bold;">\\</span><span style="color:#F97583;">*</span><span style="color:#DBEDFF;">)</span><span style="color:#85E89D;font-weight:bold;">\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;[</span><span style="color:#79B8FF;">\\</span><span style="color:#9ECBFF;">$1</span><span style="color:#79B8FF;">\\</span><span style="color:#9ECBFF;">]&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> value;</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 返回一个闭包 fn</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">withHashLength</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">replacer</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">handlerFn</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">assetInfo</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 这个 fn 作为 string.replace 的第二个参数，主要是处理 &#39;[hash:16]&#39;, &#39;[chunkhash: 16]&#39; 类似模版</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fn</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">match</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">hashLength</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">...</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (assetInfo) assetInfo.immutable </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hashLength </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">parseInt</span><span style="color:#E1E4E8;">(hashLength, </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (length </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> handlerFn) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">handlerFn</span><span style="color:#E1E4E8;">(length);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">hash</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">replacer</span><span style="color:#E1E4E8;">(match, hashLength, </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">args);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> length </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> hash.</span><span style="color:#B392F0;">slice</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, length) </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> hash;</span></span>
<span class="line"><span style="color:#E1E4E8;">  };</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> fn;</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">replacePathVariables</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">path</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">data</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">assetInfo</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">chunk</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data.chunk;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 替换 [id]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">chunkId</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chunk </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> chunk.id;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 替换 [name]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">chunkName</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chunk </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (chunk.name </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> chunk.id);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 替换 [chunkhash]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">chunkHash</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chunk </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (chunk.renderedHash </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> chunk.hash);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 处理 [chunkhash:number] 后面的 number</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">chunkHashWithLength</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> chunk </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> chunk.hashWithLength;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">contentHashType</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data.contentHashType;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 替换 [contenthash]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">contentHash</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    (chunk </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> chunk.contentHash </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> chunk.contentHash[contentHashType]) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">    data.contentHash;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 处理 [contenthash:number] 后面的 number</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">contentHashWithLength</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    (chunk </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">      chunk.contentHashWithLength </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">      chunk.contentHashWithLength[contentHashType]) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">    data.contentHashWithLength;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> data.module;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 替换 [moduleid]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">moduleId</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 替换 [modulehash]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">moduleHash</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.renderedHash </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.hash);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 处理 [modulehash:number] 后面的 number</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">moduleHashWithLength</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">module</span><span style="color:#E1E4E8;">.hashWithLength;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">typeof</span><span style="color:#E1E4E8;"> path </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;function&quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    path </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">path</span><span style="color:#E1E4E8;">(data);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// TODO</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    data.noChunkHash </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">REGEXP_CHUNKHASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(path) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">REGEXP_CONTENTHASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(path))</span></span>
<span class="line"><span style="color:#E1E4E8;">  ) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">`Cannot use [chunkhash] or [contenthash] for chunk in &#39;${</span><span style="color:#E1E4E8;">path</span><span style="color:#9ECBFF;">}&#39; (use [hash] instead)`</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">path</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">REGEXP_HASH</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">withHashLength</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(data.hash), data.hashWithLength, assetInfo)</span></span>
<span class="line"><span style="color:#E1E4E8;">      )</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">REGEXP_CHUNKHASH</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">withHashLength</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(chunkHash), chunkHashWithLength, assetInfo)</span></span>
<span class="line"><span style="color:#E1E4E8;">      )</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">REGEXP_CONTENTHASH</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">withHashLength</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(contentHash),</span></span>
<span class="line"><span style="color:#E1E4E8;">          contentHashWithLength,</span></span>
<span class="line"><span style="color:#E1E4E8;">          assetInfo</span></span>
<span class="line"><span style="color:#E1E4E8;">        )</span></span>
<span class="line"><span style="color:#E1E4E8;">      )</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">REGEXP_MODULEHASH</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">withHashLength</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(moduleHash), moduleHashWithLength, assetInfo)</span></span>
<span class="line"><span style="color:#E1E4E8;">      )</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_ID</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(chunkId))</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_MODULEID</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(moduleId))</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_NAME</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(chunkName))</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_FILE</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(data.filename))</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_FILEBASE</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(data.basename))</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_QUERY</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(data.query, </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REGEXP_URL</span><span style="color:#E1E4E8;">, </span><span style="color:#B392F0;">getReplacer</span><span style="color:#E1E4E8;">(data.url))</span></span>
<span class="line"><span style="color:#E1E4E8;">      .</span><span style="color:#B392F0;">replace</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">/</span><span style="color:#85E89D;font-weight:bold;">\[\\</span><span style="color:#DBEDFF;">(</span><span style="color:#85E89D;font-weight:bold;">\\</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">[\w:]</span><span style="color:#F97583;">+</span><span style="color:#85E89D;font-weight:bold;">\\</span><span style="color:#F97583;">*</span><span style="color:#DBEDFF;">)</span><span style="color:#85E89D;font-weight:bold;">\\\]</span><span style="color:#9ECBFF;">/</span><span style="color:#F97583;">gi</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;[$1]&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  );</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="globalhash" tabindex="-1"><a class="header-anchor" href="#globalhash" aria-hidden="true">#</a> globalHash</h2><p>globalHash hook 的触发时机是在 <code>compilation.mainTemplate.useChunkHash</code> 的时候：</p><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#24292e;"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">JavascriptModulesPlugin</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  compilation.mainTemplate.hooks.renderManifest.</span><span style="color:#B392F0;">tap</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;JavascriptModulesPlugin&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#FFAB70;">result</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">options</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">//...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">useChunkHash</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> compilation.mainTemplate.</span><span style="color:#B392F0;">useChunkHash</span><span style="color:#E1E4E8;">(chunk);</span></span>
<span class="line"><span style="color:#E1E4E8;">      result.</span><span style="color:#B392F0;">push</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">render</span><span style="color:#E1E4E8;">: () </span><span style="color:#F97583;">=&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">          compilation.mainTemplate.</span><span style="color:#B392F0;">render</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">            hash,</span></span>
<span class="line"><span style="color:#E1E4E8;">            chunk,</span></span>
<span class="line"><span style="color:#E1E4E8;">            moduleTemplates.javascript,</span></span>
<span class="line"><span style="color:#E1E4E8;">            dependencyTemplates</span></span>
<span class="line"><span style="color:#E1E4E8;">          ),</span></span>
<span class="line"><span style="color:#E1E4E8;">        filenameTemplate,</span></span>
<span class="line"><span style="color:#E1E4E8;">        pathOptions: {</span></span>
<span class="line"><span style="color:#E1E4E8;">          noChunkHash: </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">useChunkHash,</span></span>
<span class="line"><span style="color:#E1E4E8;">          contentHashType: </span><span style="color:#9ECBFF;">&quot;javascript&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">          chunk</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">        identifier: </span><span style="color:#9ECBFF;">`chunk${</span><span style="color:#E1E4E8;">chunk</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">id</span><span style="color:#9ECBFF;">}`</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        hash: useChunkHash </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> chunk.hash </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> fullHash</span></span>
<span class="line"><span style="color:#E1E4E8;">      });</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> result;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  );</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MainTemplate</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">useChunkHash</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">chunk</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">paths</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hooks.globalHashPaths.</span><span style="color:#B392F0;">call</span><span style="color:#E1E4E8;">([]);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#79B8FF;">this</span><span style="color:#E1E4E8;">.hooks.globalHash.</span><span style="color:#B392F0;">call</span><span style="color:#E1E4E8;">(chunk, paths);</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TemplatedPathPlugin</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">apply</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">compiler</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    compiler.hooks.compilation.</span><span style="color:#B392F0;">tap</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;TemplatedPathPlugin&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">compilation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">mainTemplate</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> compilation.mainTemplate;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      mainTemplate.hooks.globalHash.</span><span style="color:#B392F0;">tap</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&quot;TemplatedPathPlugin&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#FFAB70;">chunk</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">paths</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">outputOptions</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mainTemplate.outputOptions;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">publicPath</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> outputOptions.publicPath </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">filename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> outputOptions.filename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">chunkFilename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">            outputOptions.chunkFilename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> outputOptions.filename;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">// publicPath 只能含有 [hash]，这个hash 是 compilation 上的 hash</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">REGEXP_HASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(publicPath) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 以下的情况不会出现</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">REGEXP_CHUNKHASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(publicPath) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">REGEXP_CONTENTHASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(publicPath) </span><span style="color:#F97583;">||</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">REGEXP_NAME_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(publicPath)</span></span>
<span class="line"><span style="color:#E1E4E8;">          )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">// 如果 filename 含有 [hash]， mainTemplate.useChunkHash() 返回 false</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">REGEXP_HASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(filename)) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">// 如果 chunkFilename 含有 [hash]， mainTemplate.useChunkHash() 返回 false</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">REGEXP_HASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(chunkFilename)) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">// 如果 mainTemplate.hooks.globalHashPaths 返回的 path 含有 [hash]，</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">// mainTemplate.useChunkHash() 返回 false</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">REGEXP_HASH_FOR_TEST</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">test</span><span style="color:#E1E4E8;">(paths.</span><span style="color:#B392F0;">join</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;|&quot;</span><span style="color:#E1E4E8;">))) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      );</span></span>
<span class="line"><span style="color:#E1E4E8;">    });</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span></code></pre><div class="highlight-lines"><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div></div><p><code>pathOptions.noChunkHash</code> 用来判断 <code>filenameTemplate</code> 是否可以含有 <code>[chunkhash]</code>、<code>[contenthash]</code> 这样的占位符。<code>hash</code> 用于 <code>compilation.cache</code> 对象内部</p><h2 id="hashforchunk" tabindex="-1"><a class="header-anchor" href="#hashforchunk" aria-hidden="true">#</a> hashForChunk</h2><p>// TODO</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/theniceangel/edit/main/webpack4/internal-plugins/TemplatedPathPlugin.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/9/5 下午11:48:37</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: jizhi@didiglobal.com">jizhi</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/blog-site/webpack4/internal-plugins/entry/EntryOptionPlugin.html" class="nav-link" aria-label="EntryOptionPlugin"><!--[--><!--]--> EntryOptionPlugin <!--[--><!--]--></a></span><span class="next"><a href="/blog-site/webpack4/internal-plugins/WarnCaseSensitiveModulesPlugin.html" class="nav-link" aria-label="WarnCaseSensitiveModulesPlugin"><!--[--><!--]--> WarnCaseSensitiveModulesPlugin <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/blog-site/assets/js/runtime~app.b8391e89.js" defer></script><script src="/blog-site/assets/js/4640.d13a5239.js" defer></script><script src="/blog-site/assets/js/app.20f347e0.js" defer></script>
  </body>
</html>
